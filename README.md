# åç¨‹

- æ¦‚è¿°
- åç¨‹çš„åˆ›å»º
- æŒ‚èµ·å‡½æ•°ä¸å¼‚æ­¥ç»“æœ
- åç¨‹ä¸Šä¸‹æ–‡ä¸è°ƒåº¦å™¨
- è¡¥å……

# æ¦‚è¿°

###### 1ã€æ“ä½œç³»ç»Ÿçš„å¤šè¿›ç¨‹

æ“ä½œç³»ç»Ÿä¸Šæ¯ä¸ªApplicationéƒ½å¯ä»¥çœ‹åšä¸€ä¸ªè¿›ç¨‹ï¼Œå°±æ‹¿Windowsæ“ä½œç³»ç»Ÿä¸ºä¾‹å­ï¼šæµè§ˆå™¨ã€é…·ç‹—éŸ³ä¹ã€å¾®ä¿¡ç­‰è¿™äº›Applicationéƒ½æ˜¯è¿è¡Œåœ¨ä¸åŒçš„è¿›ç¨‹ä¸­çš„ã€‚å½“ç„¶è¿˜æœ‰ä¸€äº›è¿›ç¨‹æ²¡æœ‰å¿«æ·æ–¹å¼ï¼ˆæˆ–è€…å›¾æ ‡ï¼‰ï¼Œä»–ä»¬è¿è¡Œåœ¨åå°ã€‚

###### 2ã€é‚£ä¹ˆä½ çŸ¥é“å•æ ¸CPUæ˜¯æ€ä¹ˆæ‰§è¡Œå¤šä»»åŠ¡çš„å‘¢ï¼Ÿ

æ“ä½œç³»ç»Ÿè½®æµè®©å„ä¸ªä»»åŠ¡äº¤æ›¿æ‰§è¡Œï¼Œè¡¨é¢ä¸Šçœ‹ï¼Œæ¯ä¸ªä»»åŠ¡éƒ½æ˜¯äº¤æ›¿æ‰§è¡Œçš„ï¼Œä½†æ˜¯ï¼Œç”±äºCPUçš„æ‰§è¡Œé€Ÿåº¦å®åœ¨æ˜¯å¤ªå¿«äº†ï¼Œæˆ‘ä»¬æ„Ÿè§‰å°±åƒæ‰€æœ‰ä»»åŠ¡éƒ½åœ¨åŒæ—¶æ‰§è¡Œä¸€æ ·ã€‚çœŸæ­£çš„å¹¶è¡Œæ‰§è¡Œå¤šä»»åŠ¡åªèƒ½åœ¨å¤šæ ¸CPUä¸Šå®ç°ï¼Œä½†æ˜¯ï¼Œç”±äºä»»åŠ¡æ•°é‡è¿œè¿œå¤šäºCPUçš„æ ¸å¿ƒæ•°é‡ï¼Œæ‰€ä»¥ï¼Œæ“ä½œç³»ç»Ÿä¹Ÿä¼šè‡ªåŠ¨æŠŠå¾ˆå¤šä»»åŠ¡è½®æµè°ƒåº¦åˆ°æ¯ä¸ªæ ¸å¿ƒä¸Šæ‰§è¡Œã€‚

###### 3ã€çº¿ç¨‹

çº¿ç¨‹æ˜¯è¿›ç¨‹ä¸­çš„æ¦‚å¿µï¼Œæ˜¯è¿›ç¨‹ä¸­ä»»åŠ¡æ­¥éª¤çš„ç»†åˆ†ã€‚å•ä¸ªè¿›ç¨‹ä¸­å¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢ä¹Ÿæ˜¯é€šè¿‡æ“ä½œç³»ç»Ÿçš„è°ƒåº¦æ¥å®ç°çš„ã€‚

###### 4ã€åç¨‹

åç¨‹æ˜¯å¾®çº¿ç¨‹ï¼Œä¸€ä¸ªçº¿ç¨‹å¯ä»¥åˆ†ä¸ºå¤šä¸ªåç¨‹ï¼ŒåŒæ ·ä¹Ÿæ˜¯è½®è¯¢æ‰§è¡Œï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯å‡å°‘CPUçš„èµ„æºæ¶ˆè€—ï¼Œä¸€äº›æ¯”è¾ƒå¤šè€Œä¸”å°çš„äº‹ä»¶å¯ä»¥ç”¨åç¨‹å»å¤„ç†ï¼Œå‡å°‘èµ„æºçš„å¼€é”€ã€‚

åç¨‹å…è®¸åœ¨å•çº¿ç¨‹æ¨¡å¼ä¸‹æ¨¡æ‹Ÿå¤šçº¿ç¨‹ç¼–ç¨‹çš„æ•ˆæœ,ä»£ç æ‰§è¡Œæ—¶çš„æŒ‚èµ·ä¸æ¢å¤å®Œå…¨æ˜¯ç”±ç¼–ç¨‹è¯­è¨€æ¥æ§åˆ¶,å’Œæ“ä½œç³»ç»Ÿæ— å…³ã€‚

###### 5ã€å°ç»“

å¯ä»¥å‘ç°ï¼šå¤šè¿›ç¨‹ã€å¤šçº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢ä¾é æ“ä½œç³»ç»Ÿæ¥è°ƒåº¦ã€‚è€Œåç¨‹ä¹‹é—´çš„åˆ‡æ¢ç”±ç¼–ç¨‹è¯­è¨€è®¾è®¡æ—¶å†³å®šã€‚å…·ä½“çš„è°ƒåº¦éƒ½ä¸æ˜¯ç”±ä½¿ç”¨è€…å†³å®šçš„ã€‚


# ä¾èµ–

ä½¿ç”¨åç¨‹åº“éœ€è¦å•ç‹¬å¼•å…¥ä¾èµ–

```groovy
    // åç¨‹æ ¸å¿ƒåº“
    implementation "org.jetbrains.kotlinx:kotlinx-coroutines-core-jvm:1.6.1"
    // åç¨‹Androidæ”¯æŒåº“
    implementation "org.jetbrains.kotlinx:kotlinx-coroutines-android:1.6.1"
```

è¿™é‡Œä½¿ç”¨äº†kotlinx-coroutines-core-jvmå…¶å®kotlinx-coroutinesè¿˜æä¾›äº†å…¶ä»–æ¨¡å—å…·ä½“åŠŸèƒ½å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://github.com/hltj/kotlinx.coroutines-cn/blob/master/README.md#using-in-your-projects)

kotlinx-coroutines-android æ˜¯å»ºç«‹åœ¨ kotlinx-coroutines-core-jvm ä¹‹ä¸Šçš„ä¸€ä¸ªä¸“é—¨ä¸º Android å®šåˆ¶çš„æ¨¡å—ï¼Œæä¾›äº†æ›´æ–¹ä¾¿çš„ API å’ŒåŠŸèƒ½ï¼Œä»¥é€‚åº” Android å¹³å°çš„ç‰¹æ®Šéœ€æ±‚ã€‚åœ¨ Android å¼€å‘ä¸­ï¼Œé€šå¸¸ä½ ä¼šåŒæ—¶å¼•å…¥è¿™ä¸¤ä¸ªåº“ï¼Œä»¥å……åˆ†åˆ©ç”¨åç¨‹åœ¨å¼‚æ­¥ç¼–ç¨‹æ–¹é¢çš„ä¼˜åŠ¿ï¼Œå¹¶ä¸ Android å¹³å°è¿›è¡Œè‰¯å¥½çš„é›†æˆã€‚

æˆ‘ä»¬è¿˜å¯ä»¥æ ¹æ®é€‰æ‹©æ·»åŠ ä¸€äº›ktsæ‹“å±•åº“

```kotlin
    //viewModelå¯¹åç¨‹æ‰©å±•å°è£…ï¼ˆviewModelScopeï¼‰
    implementation "androidx.lifecycle:lifecycle-viewmodel-ktx:2.2.0"
    // lifecycleå¯¹åç¨‹çš„æ‰©å±•å°è£…ï¼ˆlifeCycleScopeï¼‰
    implementation "androidx.lifecycle:lifecycle-runtime-ktx:2.2.0"
```

è‹¥éœ€è¦æ·»åŠ å…¶ä»–ktsåº“å¯ä»¥æŸ¥çœ‹[å®˜æ–¹æ–‡æ¡£](https://developer.android.google.cn/kotlin/ktx?hl=zh-cn#core)


# åç¨‹çš„åˆ›å»º

Kotlinä¸­å¸¸è§çš„å‡ ç§åˆ›å»ºæ–¹å¼

- GlobalScope
- runBlocking
- MainScope
- CoroutineScope
- viewModelScopeï¼ˆéœ€è¦å•ç‹¬å¼•å…¥å¯¹åº”ktxæ‰©å±•ï¼‰
- lifecycleScopeï¼ˆéœ€è¦å•ç‹¬å¼•å…¥å¯¹åº”ktxæ‰©å±•ï¼‰

éœ€è¦æ³¨æ„ç‚¹

- åç¨‹æ˜¯è½»é‡çº§çš„çº¿ç¨‹ã€‚ å®ƒä»¬è¿è¡Œåœ¨åç¨‹ä¸Šä¸‹æ–‡ä¸­ï¼Œé€šè¿‡ launch åç¨‹æ„å»ºå™¨å¯ä»¥åœ¨åç¨‹ä¸Šä¸‹æ–‡ä¸­å¼€å¯ä¸€ä¸ªæºç¨‹ã€‚
- åç¨‹æ˜¯ä¾èµ–çº¿ç¨‹çš„ï¼Œæ‰€ä»¥å…¶ç”Ÿå‘½å‘¨æœŸå—æ‰€å±çº¿ç¨‹çš„å½±å“ã€‚çº¿ç¨‹æ‰§è¡Œå®Œæ¯•åç¨‹ä¹Ÿä¼šå…³é—­ã€‚
- çº¿ç¨‹æä¾›äº†Thread.sleep æ¥é˜»å¡å½“å‰çº¿ç¨‹ï¼Œåç¨‹ä¹Ÿæä¾›äº†ç›¸åº”çš„æŒ‚èµ·å‡½æ•°delayæ¥é˜»å¡å½“å‰åç¨‹ã€‚æ³¨æ„delayè¿™ä¸ªæŒ‚èµ·å‡½æ•°ä¼šé˜»å¡å½“å‰åæˆä½†ä¸ä¼šé˜»å¡åæˆæ‰€å±çš„çº¿ç¨‹ã€‚

###### 1ã€GlobalScope.launch{}

GlobalScope æ˜¯ä¸€ä¸ªé¡¶å±‚çš„ CoroutineScopeï¼Œå®ƒç”¨äºå¯åŠ¨é¡¶çº§åç¨‹ï¼Œè¿™äº›åç¨‹çš„ç”Ÿå‘½å‘¨æœŸä¸æ•´ä¸ªåº”ç”¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸç›¸åŒã€‚

GlobalScope çš„åç¨‹ä¸å—é™äºç‰¹å®šçš„ä½œç”¨åŸŸï¼Œå› æ­¤å®ƒä»¬å¯ä»¥åœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­è¿è¡Œã€‚åœ¨ä½¿ç”¨ GlobalScope æ—¶ï¼Œéœ€è¦æ³¨æ„ï¼Œå®ƒåˆ›å»ºçš„åç¨‹åœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸå†…éƒ½ä¼šå­˜åœ¨ï¼Œå› æ­¤éœ€è¦å°å¿ƒé¿å…å†…å­˜æ³„æ¼ã€‚


```kotlin
class MainActivity : AppCompatActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
        GlobalScope.launch {
            println("my-test hello kt Coroutine ï¼")
        }
        println("my-test main threadï¼")
    }
}
```
å¾ˆç®€å•ä½¿ç”¨GlobalScopeçš„launchæ–¹æ³•å¼€å¯ä¸€ä¸ªåç¨‹,è¿™é‡Œæˆ‘ä»¬å…ˆæ˜ç™½ä¸€ç‚¹GlobalScope.launchå¼€å¯çš„åç¨‹é»˜è®¤è·‘åœ¨ å­çº¿ç¨‹ä¸­ã€å­çº¿ç¨‹ä¸­ã€å­çº¿ç¨‹ä¸­ã€‚


###### 2ã€runBlocking{launch{}}

runBlocking{}ä¹Ÿèƒ½åˆ›å»ºä¸€ä¸ªåç¨‹çš„ä¸Šä¸‹æ–‡ç¯å¢ƒ,å®ƒå¯ä»¥ä¿è¯åœ¨è¡¨è¾¾å¼å†…çš„æ‰€æœ‰ä»£ç å’Œå­åç¨‹æ²¡æœ‰å…¨éƒ¨æ‰§è¡Œå®Œä¹‹å‰ä¸€ç›´é˜»å¡ å½“å‰ å½“å‰ å½“å‰çº¿ç¨‹.runBlockingå‡½æ•°é€šå¸¸åªåº”è¯¥åœ¨æµ‹è¯•ç¯å¢ƒä¸‹ä½¿ç”¨,åœ¨æ­£å¼ç¯å¢ƒä¸­å®¹æ˜“äº§ç”Ÿæ€§èƒ½ä¸Šçš„é—®é¢˜.

æ­¤ç§æ–¹å¼å¼€å¯åç¨‹ï¼Œé»˜è®¤çš„çº¿ç¨‹è°ƒåº¦ä¸ºå½“å‰çº¿ç¨‹ã€‚æ€æ ·ç†è§£å‘¢ï¼Ÿ

- å¦‚æœrunBlockingæ‰€å¤„çš„çº¿ç¨‹ä¸ºMainçº¿ç¨‹åˆ™launchæ‰€å¤„çš„çº¿ç¨‹é»˜è®¤ä¸ºMainçº¿ç¨‹

- å¦‚æœrunBlockingæ‰€å¤„çš„çº¿ç¨‹ä¸ºworkçº¿ç¨‹åˆ™launchæ‰€å¤„çš„çº¿ç¨‹é»˜è®¤ä¸ºWorkçº¿ç¨‹

çœ‹ä¸ªğŸŒ°

```kotlin
class MainActivity : AppCompatActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        thread {
            runBlocking {
                launch {
                    println("runningBlock2ï¼š${Thread.currentThread().name}")
                }
            }
        }
        
        runBlocking {
            launch {
                println("runningBlock1ï¼š${Thread.currentThread().name}")
            }
        }
    }
}

I  runningBlock1ï¼šmain
I  runningBlock2ï¼šThread-2
```

###### 3ã€MainScope

MainScope æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ CoroutineScopeï¼Œé€šå¸¸ç”¨äºä¸ UI çº¿ç¨‹ç›¸å…³çš„åç¨‹æ“ä½œã€‚MainScope çš„è®¾è®¡ç›®çš„æ˜¯ä¸ºäº†ç®€åŒ–ä¸ Android åº”ç”¨ç¨‹åºæˆ–è€…å…¶ä»– UI æ¡†æ¶é›†æˆæ—¶çš„åç¨‹ç®¡ç†ã€‚

UI æ“ä½œéœ€è¦åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œè€Œåç¨‹é»˜è®¤åœ¨åå°çº¿ç¨‹ä¸Šè¿è¡Œã€‚ä¸ºäº†åœ¨åç¨‹ä¸­æ‰§è¡Œ UI æ“ä½œï¼Œå¯ä»¥ä½¿ç”¨ MainScope æ¥åˆ›å»ºä¸€ä¸ªä¸ä¸»çº¿ç¨‹å…³è”çš„åç¨‹ä½œç”¨åŸŸã€‚

```kotlin
class MainActivity : AppCompatActivity() {
    private val mainScope = MainScope()
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
        mainScope.launch {
            delay(1000*10)
            println("my-test: main scope test")
        }
    }

    override fun onDestroy() {
        super.onDestroy()
        //å–æ¶ˆä¸ä¸»çº¿ç¨‹å…³è”çš„å†™æˆï¼Œé¿å…å†…å­˜æ³„æ¼
        mainScope.cancel()
    }
}
```

è¿™é‡Œæˆ‘ä»¬å°±éœ€è¦ç•™æ„å‡ ç‚¹äº†ï¼š

- MainScopeå¼€å¯åç¨‹ååç¨‹è¿è¡Œåœ¨UIçº¿ç¨‹ï¼Œåç¨‹å†…çš„è€—æ—¶æ“ä½œä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹ã€‚ä¸ºå•¥å‘¢ï¼Ÿè¿™é‡Œæ¶‰åŠåˆ°äº†åç¨‹çš„Dispatchersï¼ŒMainScopeçš„Dispatchersæ˜¯
Dispatchers.Mainï¼Œåç¨‹åº“ä¸“é—¨è¿›è¡Œäº†å¤„ç†ï¼ŒDispatchers.Mainçš„åç¨‹å†…å¯ä»¥è¿›è¡ŒUIæ“ä½œã€‚
- MainScopeä½¿ç”¨å®Œæ¯•åè®°å¾—cancelï¼Œè¿™ä¸ªéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å¤„ç†ä¸‹ã€‚



###### 4ã€CoroutineScope(job)

CoroutineScopeä¹Ÿå…·æœ‰åç¨‹ä¸Šä¸‹æ–‡ï¼Œä½¿ç”¨CoroutineScopeçš„launchåˆ›å»ºçš„åç¨‹ç»Ÿç»Ÿä¼šè¢«jobæ‰€ç®¡ç†.å¤§å¤§é™ä½åç¨‹ç»´æŠ¤æˆæœ¬.

```kotlin
    val job = Job()
    val scope = CoroutineScope(job) 
    scope.launch {
       // todo 
    }
    job.cancel()
```

æ­¤ç§æ–¹å¼å¼€å¯åç¨‹ï¼Œé»˜è®¤çš„çº¿ç¨‹è°ƒåº¦ä¸ºå­çº¿ç¨‹. ç»†å¿ƒçš„æˆ‘ä»¬ä¼šå‘ç°MainScopeå°±æ˜¯å¯¹CoroutineScopeçš„å°è£…ï¼Œå†™æ­»äº†çº¿ç¨‹è°ƒåº¦å™¨ã€‚è®°ä½ä½¿ç”¨CoroutineScope
ä¹Ÿè®°å¾—åœ¨Androidç»„ä»¶ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶cancelã€‚

###### 5ã€viewModelScope

è¿™ä¸ªå¾ˆç®€å•ï¼Œæ˜¯ktxå¯¹åç¨‹çš„æ‰©å±•ï¼Œandroidä¸­é»˜è®¤å¸®æˆ‘ä»¬å¤„ç†äº†ç”Ÿå‘½å‘¨æœŸã€‚é»˜è®¤è·‘åœ¨UIçº¿ç¨‹ã€‚å¯é€šè¿‡ä»»åŠ¡è°ƒåº¦å™¨æ‰‹åŠ¨åˆ‡æ¢çº¿ç¨‹

```kotlin
class MainViewModel:ViewModel() {
    fun login() = viewModelScope.launch { 
        delay(1000)
    }
}
```

# æŒ‚èµ·å‡½æ•°ä¸å¼‚æ­¥ç»“æœ

æŒ‚èµ·å‡½æ•°æ¦‚å¿µæˆ‘ä»¬å¯ä»¥å…ˆä¸çœ‹ï¼Œç›®å‰æˆ‘ä»¬åªéœ€çŸ¥é“å¦‚ä¸‹ï¼š

delayæ˜¯æˆ‘ä»¬æ¥è§¦çš„ç¬¬ä¸€ä¸ªæŒ‚èµ·å‡½æ•°ï¼Œä»–çš„ä½œç”¨æ˜¯éé˜»å¡å½“å‰çº¿ç¨‹ï¼Œé˜»å¡å½“å‰æºç¨‹ã€‚

Suspend function should be called only from a coroutine or another suspend function

###### 1ã€æŒ‚èµ·å‡½æ•°å®šä¹‰&è°ƒç”¨

é€šè¿‡suspendå…³é”®å­—å®šä¹‰çš„å‡½æ•°å°±æ˜¯æŒ‚èµ·å‡½æ•°ã€‚

```kotlin
fun main() = runBlocking {
    // è®¡ç®—é¡ºåºè°ƒç”¨çš„æ‰§è¡Œæ—¶é—´
    val time = measureTimeMillis {
        val a = testOne()
        val b = testTwo()
        println("a+b=${a+b}")
    }
    println("è€—æ—¶ï¼š$time ms")
}

suspend fun testOne(): Int {
    delay(1000)
    return 10
}

suspend fun testTwo(): Int {
    delay(1000)
    return 20
}

log:
a+b=30
è€—æ—¶ï¼š2045 ms
```
ä»£ç é¡ºåºæ‰§è¡Œï¼Œä»£ç å»¶è¿Ÿæ—¶é—´+ä»£ç æ‰§è¡Œæ—¶é—´æ˜¯å¤§äº2ç§’çš„ã€‚ç¬¦åˆé¢„æœŸ~

###### 2ã€å¸¦è¿”å›ç»“æœçš„åç¨‹async

ktä¸­å¼€å¯åç¨‹æœ‰ä¸¤ç§æ–¹å¼ï¼šlaunch{} ã€async{}äºŒè€…çš„ä¸åŒç‚¹åœ¨äº

- launch{}ä¼šè¿”å›ä¸€ä¸ªJobå¹¶ä¸”ä¸é™„å¸¦ä»»ä½•ç»“æœå€¼ã€‚
- async{}ä¼šè¿”å›ä¸€ä¸ªDeferredï¼Œå¯ä»¥ä½¿ç”¨Deferred.await()æ¥è·å–è¿™ä¸ªå¼‚æ­¥ç»“æœï¼ŒDeferredä¹Ÿæ˜¯ä¸€ä¸ª Jobï¼Œå¦‚æœéœ€è¦æˆ‘ä»¬ä¹Ÿå¯ä»¥å–æ¶ˆå®ƒã€‚

è¿˜æ˜¯ä¸Šè¿°æ —å­ï¼Œå‡å¦‚testOneã€testTwoä¸¤ä¸ªå‡½æ•°æ²¡æœ‰æ‰§è¡Œé¡ºåºï¼Œè¿™æ—¶å¯ä»¥è®©äºŒè€…å¹¶å‘æ‰§è¡Œï¼Œè€Œä¸”ä½¿ç”¨asyncå¯ä»¥è·å–æ‰§è¡Œç»“æœï¼š

```kotlin
fun main() = runBlocking {
    // è®¡ç®—å¹¶å‘æ‰§è¡Œçš„æ€»æ—¶é—´
    val time = measureTimeMillis {
        val a = async { testOne() } 
        val b = async {  testTwo() }
        println("a+b=${a.await()+b.await()}")
    }
    println("è€—æ—¶ï¼š$time ms")
}

suspend fun testOne(): Int {
    delay(1000)
    return 10
}

suspend fun testTwo(): Int {
    delay(1000)
    return 20
}

log:
a+b=30
è€—æ—¶ï¼š1032 ms
```

å¯è§å¸¦è¿”å›ç»“æœçš„asyncå¾ˆå®¹æ˜“å®ç°å¼‚æ­¥è®¡ç®—~

åˆšæ¥è§¦ï¼Œè¿™é‡Œæœ‰äººå¯èƒ½ä¼šå‡ºç°ç–‘æƒ‘ï¼šlaunchä¹Ÿæ˜¯å¼€å¯äº†åç¨‹ï¼Œä¹Ÿæ˜¯å¼‚æ­¥çš„ï¼Œä¸ºå•¥è¿˜è¦è®¾è®¡asyncå‘¢ï¼Ÿ è¿™é‡Œéœ€è¦æ˜ç™½è¿™ç‚¹ï¼š

asyncçš„è®¾è®¡æ˜¯æœ‰è¿”å›ç»“æœçš„ï¼Œå¯ä»¥å¼‚æ­¥è®¡ç®—ï¼Œè€Œlaunchæ— è¿”å›ç»“æœï¼Œä¸å¯è¿›è¡Œå¼‚æ­¥è®¡ç®—ã€‚


###### 3ã€asyncçš„æƒ°æ€§å¯åŠ¨

å¦‚æœä¸æƒ³async{}ä¹‹åå°±ç«‹å³å¯åŠ¨åç¨‹å¯ä»¥é€šè¿‡å°† start å‚æ•°è®¾ç½®ä¸º CoroutineStart.LAZY è€Œå˜ä¸ºæƒ°æ€§çš„ã€‚

è¿™æ ·åªæœ‰ç»“æœé€šè¿‡ await è·å–çš„æ—¶å€™åç¨‹æ‰ä¼šå¯åŠ¨ï¼Œæˆ–è€…åœ¨ Jobçš„ start å‡½æ•°è°ƒç”¨çš„æ—¶å€™ã€‚

```kotlin
class MainActivity : AppCompatActivity() {

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        lifecycleScope.launch {

            val def = async(start = CoroutineStart.LAZY) {
                println("my-test: async")
                1
            }

            delay(1000*10)
            val result = def.await()
            println("my-test: result:$result")
        }
    }
}

```

æˆ‘ä»¬ä¼šå‘ç°ç¨‹åºè·‘èµ·æ¥10såä¸¤ä¸ªlogä¼šä¾æ¬¡æ‰“å°ã€‚åœ¨æ­¤ä¹‹å‰æ— logæ‰“å°


# åç¨‹ä¸Šä¸‹æ–‡ä¸è°ƒåº¦å™¨

###### 1ã€è°ƒåº¦å™¨ä¸çº¿ç¨‹

åç¨‹ä¸Šä¸‹æ–‡åŒ…å«ä¸€ä¸ªåç¨‹è°ƒåº¦å™¨ ï¼ˆ CoroutineDispatcherï¼‰å®ƒç¡®å®šäº†ç›¸å…³çš„åç¨‹åœ¨å“ªä¸ªçº¿ç¨‹æˆ–å“ªäº›çº¿ç¨‹ä¸Šæ‰§è¡Œã€‚åç¨‹è°ƒåº¦å™¨å¯ä»¥å°†åç¨‹é™åˆ¶åœ¨ä¸€ä¸ªç‰¹å®šçš„çº¿ç¨‹æ‰§è¡Œï¼Œæˆ–å°†å®ƒåˆ†æ´¾åˆ°ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œäº¦æˆ–æ˜¯è®©å®ƒä¸å—é™åœ°è¿è¡Œã€‚
æ‰€æœ‰çš„åç¨‹æ„å»ºå™¨è¯¸å¦‚ launch å’Œ async æ¥æ”¶ä¸€ä¸ªå¯é€‰çš„ CoroutineDispatcher å‚æ•°ï¼Œå®ƒå¯ä»¥è¢«ç”¨æ¥æ˜¾å¼çš„ä¸ºä¸€ä¸ªæ–°åç¨‹æˆ–å…¶å®ƒä¸Šä¸‹æ–‡å…ƒç´ æŒ‡å®šä¸€ä¸ªè°ƒåº¦å™¨ã€‚

```kotlin
@ObsoleteCoroutinesApi
fun main() = runBlocking<Unit> {
     // é»˜è®¤è¿è¡Œåœ¨å½“å‰çº¿ç¨‹   
     launch{

     }
    //ä¸»åŠ¨æŒ‡å®šè¿è¡Œåœ¨IOçº¿ç¨‹
    launch (Dispatchers.IO){ 
       
    }
    // ä¸»åŠ¨æŒ‡å®šè¿è¡Œåœ¨ä¸»çº¿ç¨‹    
    async(Dispatchers.Main) {
      
    }
}
```

Dispatchersä¸­å®šä¹‰äº†å¦‚ä¸‹ï¼š

- Default é»˜è®¤çš„è°ƒåº¦å™¨ã€‚æ­¤è°ƒåº¦ç¨‹åºç»è¿‡äº†ä¸“é—¨ä¼˜åŒ–ï¼Œé€‚åˆåœ¨ä¸»çº¿ç¨‹ä¹‹å¤–æ‰§è¡Œå ç”¨å¤§é‡ CPU èµ„æºçš„å·¥ä½œã€‚ç”¨ä¾‹ç¤ºä¾‹åŒ…æ‹¬å¯¹åˆ—è¡¨æ’åºå’Œè§£æ JSON
- Mainï¼šåç¨‹è¿è¡Œåœ¨Mainçº¿ç¨‹
- Unconfined æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„è°ƒåº¦å™¨ä¸”ä¼¼ä¹ä¹Ÿè¿è¡Œåœ¨main çº¿ç¨‹ä¸­ï¼Œä½†å®é™…ä¸Šï¼Œ å®ƒæ˜¯ä¸€ç§ä¸åŒçš„æœºåˆ¶ï¼Œè¿™ä¼šåœ¨åæ–‡ä¸­è®²åˆ°ã€‚
- IO åç¨‹è¿è¡Œåœ¨IOçº¿ç¨‹

###### 2ã€å­åç¨‹

å½“ä¸€ä¸ªåç¨‹åœ¨å…¶å®ƒåç¨‹ä¸­å¯åŠ¨çš„æ—¶å€™ï¼Œå®ƒå°†é€šè¿‡ CoroutineScope.coroutineContext æ¥æ‰¿è¢­ä¸Šä¸‹æ–‡ï¼Œå¹¶ä¸”è¿™ä¸ªæ–°åç¨‹çš„ Job å°†ä¼šæˆä¸ºçˆ¶åç¨‹ä½œä¸šçš„å­ä½œä¸šã€‚å½“ä¸€ä¸ªçˆ¶åç¨‹è¢«å–æ¶ˆçš„æ—¶å€™ï¼Œæ‰€æœ‰å®ƒçš„å­åç¨‹ä¹Ÿä¼šè¢«é€’å½’çš„å–æ¶ˆã€‚

æ³¨æ„ï¼šå½“ä½¿ç”¨ GlobalScope æ¥å¯åŠ¨ä¸€ä¸ªåç¨‹æ—¶ï¼Œåˆ™æ–°åç¨‹çš„ä½œä¸šæ²¡æœ‰çˆ¶ä½œä¸šã€‚ å› æ­¤å®ƒä¸è¿™ä¸ªå¯åŠ¨çš„ä½œç”¨åŸŸæ— å…³ä¸”ç‹¬ç«‹è¿ä½œã€‚

###### 3ã€åç¨‹å‘½å

launch{}  æˆ–è€…async{} ä¼ å‚CoroutineName("xxx") å³å¯

```kotlin
val v1 = async(CoroutineName("xxx")) {}
```

æ³¨æ„æœ‰æ—¶æˆ‘ä»¬éœ€è¦åœ¨åç¨‹ä¸Šä¸‹æ–‡ä¸­å®šä¹‰å¤šä¸ªå…ƒç´ ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ + æ“ä½œç¬¦æ¥å®ç°ã€‚ æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬å¯ä»¥æ˜¾å¼æŒ‡å®šä¸€ä¸ªè°ƒåº¦å™¨æ¥å¯åŠ¨åç¨‹å¹¶ä¸”åŒæ—¶æ˜¾å¼æŒ‡å®šä¸€ä¸ªå‘½å:

```kotlin
fun main() = runBlocking<Unit> {

    launch(Dispatchers.Unconfined+CoroutineName("aaa")) {

    }

}
```

# åŠŸèƒ½å¼ºå¤§çš„withContext

withContextå¯ä»¥ç†è§£ä¸ºasyncå‡½æ•°çš„ç®€åŒ–ç‰ˆ,å®ƒæ˜¯ä¸€ä¸ªæŒ‚èµ·å‡½æ•°,è¿”å›ç»“æœæ˜¯withContextå‡½æ•°ä½“å†…æœ€åä¸€è¡Œã€‚ä»£ç ç›¸å½“äºval result = async{a+b}.await()

```kotlin
fun main() = runBlocking {
    val result = withContext(Dispatchers.Default) {
        1+1
    }
    println(result)
}
```
withContextçš„ä»»æ„åˆ‡æ¢çº¿ç¨‹ã€æ¶ˆé™¤äº†å›è°ƒè¿˜æ˜¯å¾ˆniceçš„

```kotlin
class MainActivity : AppCompatActivity() {

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        lifecycleScope.launch(Dispatchers.Main) {
            println("my test lifecycleScope.launch1 - ${Thread.currentThread().name}")
            val json = withContext(Dispatchers.IO) {
                getDataFromBackend()
            }
            println("my test lifecycleScope.launch2 - ${Thread.currentThread().name}")
            // parse json and update ui
        }
    }

    private suspend fun getDataFromBackend(): String {
        println("my test getDataFromBackend - ${Thread.currentThread().name}")
        // æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚
        return "i am json"
    }
}
```
I  my test lifecycleScope.launch1 - main
I  my test getDataFromBackend - DefaultDispatcher-worker-2
I  my test lifecycleScope.launch2 - main

å¦‚å›¾ä»¥åŒæ­¥çš„æ–¹å¼å†™å¼‚æ­¥æ“ä½œååˆ†nice~  getDataFromBackendæ˜¯ä¸€ä¸ªæŒ‚èµ·å‡½æ•°ï¼Œè¿™è·‘åœ¨workçº¿ç¨‹ä¸­withContextå—ä»¥å¤–çš„ä»£ç éƒ½æ˜¯è·‘åœ¨ä¸»çº¿ç¨‹çš„ã€‚

# The End 

[Kotlin coroutines doc](https://legacy.kotlincn.net/docs/reference/coroutines/coroutines-guide.html)

[Kotlin coroutines in Android](https://developer.android.google.cn/kotlin/coroutines?hl=zh_cn)
